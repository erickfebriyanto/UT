<!DOCTYPE html>
<html lang="id">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Tracking Pengiriman</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/styles.css">
</head>
<body>
	<div id="navbar"></div>

	<div class="container my-4">
		<div class="card shadow-sm">
			<div class="card-body">
				<h1 class="h4 mb-3">Tracking Pengiriman</h1>

				<form id="formTracking" class="row g-2">
					<div class="col-12 col-md-6">
						<label for="inputNomorDO" class="form-label">Nomor Delivery Order</label>
						<input type="text" class="form-control" id="inputNomorDO" placeholder="Masukkan Nomor DO, contoh: 2023001234" required>
					</div>
					<div class="col-12 col-md-3 d-flex align-items-end">
						<button type="submit" class="btn btn-primary w-100" id="btnCari">Cari</button>
					</div>
				</form>

				<div id="alertNotFound" class="alert alert-warning mt-3 d-none">Data tidak ditemukan. Periksa Nomor DO dan coba lagi.</div>

				<div id="hasilWrapper" class="mt-4 d-none">
					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<div class="text-muted small">Nomor DO</div>
								<div id="hasilNomorDO" class="fw-semibold"></div>
							</div>
							<div>
								<span class="text-muted small d-block">Status</span>
								<span id="hasilStatusBadge" class="badge bg-secondary"></span>
							</div>
						</div>
					</div>

					<div class="mb-3">
						<div class="text-muted small">Nama Mahasiswa</div>
						<div id="hasilNama" class="fs-6 fw-semibold"></div>
					</div>

					<div class="mb-4">
						<div class="d-flex justify-content-between">
							<span class="small text-muted">Progress Pengiriman</span>
							<span id="hasilProgressText" class="small fw-semibold"></span>
						</div>
						<div class="progress" role="progressbar" aria-label="Progress pengiriman" aria-valuemin="0" aria-valuemax="100">
							<div id="hasilProgressBar" class="progress-bar" style="width: 0%"></div>
						</div>
					</div>

					<div class="row g-3">
						<div class="col-12 col-lg-6">
							<div class="card">
								<div class="card-body">
									<h2 class="h6">Detail Pengiriman</h2>
									<div class="row row-cols-1 gy-2 mt-2">
										<div class="col d-flex justify-content-between">
											<span class="text-muted">Ekspedisi</span>
											<strong id="hasilEkspedisi"></strong>
										</div>
										<div class="col d-flex justify-content-between">
											<span class="text-muted">Tanggal Kirim</span>
											<strong id="hasilTanggalKirim"></strong>
										</div>
										<div class="col d-flex justify-content-between">
											<span class="text-muted">Jenis Paket</span>
											<strong id="hasilPaket"></strong>
										</div>
										<div class="col d-flex justify-content-between">
											<span class="text-muted">Total Pembayaran</span>
											<strong id="hasilTotal"></strong>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-12 col-lg-6">
							<div class="card">
								<div class="card-body">
									<h2 class="h6">Riwayat Perjalanan</h2>
									<ul id="hasilPerjalanan" class="list-group list-group-flush mt-2"></ul>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="js/data.js"></script>
	<script>

		const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
		if (!currentUser) window.location.href = 'index.html';

		fetch('partials/navbar.html').then(r => r.text()).then(html => {
			document.getElementById('navbar').innerHTML = html;
			const el = document.getElementById('userName');
			if (el) el.textContent = currentUser.nama;
		});

		function hitungProgress(perjalanan = []) {
			if (!perjalanan.length) return { p: 10, lbl: 'Diproses', bar: 'bg-secondary', badge: 'bg-secondary' };
			const last = (perjalanan[perjalanan.length - 1]?.keterangan || '').toLowerCase();
			if (last.includes('selesai antar')) return { p: 100, lbl: 'Terkirim', bar: 'bg-success', badge: 'bg-success' };
			if (last.includes('proses antar')) return { p: 80, lbl: 'Sedang Diantar', bar: 'bg-primary', badge: 'bg-primary' };
			if (last.includes('tiba di hub')) return { p: 60, lbl: 'Di Hub', bar: 'bg-info', badge: 'bg-warning' };
			if (last.includes('penerimaan di loket')) return { p: 30, lbl: 'Diterima di Loket', bar: 'bg-secondary', badge: 'bg-secondary' };
			return { p: 40, lbl: 'Dalam Perjalanan', bar: 'bg-info', badge: 'bg-warning' };
		}

		function renderHasil(noDO, d) {
			document.getElementById('hasilWrapper').classList.remove('d-none');
			document.getElementById('alertNotFound').classList.add('d-none');

			document.getElementById('hasilNomorDO').textContent = noDO;
			document.getElementById('hasilNama').textContent = d.nama || '-';

			const prog = hitungProgress(d.perjalanan);
			const status = document.getElementById('hasilStatusBadge');
			status.className = `badge ${prog.badge}`;
			status.textContent = d.status || prog.lbl;

			const bar = document.getElementById('hasilProgressBar');
			bar.className = `progress-bar ${prog.bar}`;
			bar.style.width = prog.p + '%';
			document.getElementById('hasilProgressText').textContent = prog.p + '%';

			document.getElementById('hasilEkspedisi').textContent = d.ekspedisi || '-';
			document.getElementById('hasilTanggalKirim').textContent = d.tanggalKirim || '-';
			document.getElementById('hasilPaket').textContent = d.paket || '-';
			document.getElementById('hasilTotal').textContent = d.total || '-';

			const ul = document.getElementById('hasilPerjalanan');
			ul.innerHTML = '';
			(d.perjalanan || []).forEach(i => {
				const li = document.createElement('li');
				li.className = 'list-group-item';
				li.innerHTML = `<div class="small text-muted">${i.waktu || '-'}</div><div>${i.keterangan || '-'}</div>`;
				ul.appendChild(li);
			});
		}

		function renderNotFound() {
			document.getElementById('hasilWrapper').classList.add('d-none');
			document.getElementById('alertNotFound').classList.remove('d-none');
		}

		document.getElementById('formTracking').addEventListener('submit', e => {
			e.preventDefault();
			const no = document.getElementById('inputNomorDO').value.trim();
			if (!no) return renderNotFound();
			const data = dataTracking?.[no];
			data ? renderHasil(no, data) : renderNotFound();
		});

		function logout() { sessionStorage.removeItem('currentUser'); window.location.href = 'index.html'; }
		window.logout = logout;
	</script>
</body>
</html>

