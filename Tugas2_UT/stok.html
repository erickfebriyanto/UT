<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Bahan Ajar</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <!-- CSS kustom (untuk class .cover-44) -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Placeholder navbar -->
    <div id="navbar"></div>

    <!-- Container utama -->
    <div id="stokApp" class="container my-4">
        <!-- Header halaman -->
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h4 m-0">Stok Bahan Ajar</h1>
            <button @click="toggleFormTambah" class="btn btn-success">
                <span v-if="!showFormTambah">+ Tambah Bahan Ajar</span>
                <span v-else>âœ• Tutup Form</span>
            </button>
        </div>

        <!-- ===== FORM TAMBAH BAHAN AJAR BARU ===== -->
        <div v-if="showFormTambah" class="card mb-4 shadow-sm">
            <div class="card-body">
                <h2 class="h5 mb-3">Tambah Bahan Ajar Baru</h2>
                
                <form @submit.prevent="tambahBahanAjar" class="row g-3">
                    <!-- Kode MK -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Kode Mata Kuliah <span class="text-danger">*</span></label>
                        <input v-model="formTambah.kode" type="text" class="form-control" 
                               placeholder="Contoh: EKMA4116" maxlength="10" required>
                        <small v-if="errorKode" class="text-danger d-block mt-1">{{ errorKode }}</small>
                    </div>

                    <!-- Judul -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nama Mata Kuliah <span class="text-danger">*</span></label>
                        <input v-model="formTambah.judul" type="text" class="form-control" 
                               placeholder="Contoh: Pengantar Manajemen" required>
                        <small v-if="errorJudul" class="text-danger d-block mt-1">{{ errorJudul }}</small>
                    </div>

                    <!-- Kategori -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Kategori <span class="text-danger">*</span></label>
                        <select v-model="formTambah.kategori" class="form-select" required>
                            <option value="">-- Pilih Kategori --</option>
                            <option v-for="kat in kategoriList" :key="kat" :value="kat">{{ kat }}</option>
                        </select>
                    </div>

                    <!-- UT-Daerah -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">UT-Daerah <span class="text-danger">*</span></label>
                        <select v-model="formTambah.upbjj" class="form-select" required>
                            <option value="">-- Pilih UT-Daerah --</option>
                            <option v-for="upbjj in upbjjList" :key="upbjj" :value="upbjj">{{ upbjj }}</option>
                        </select>
                    </div>

                    <!-- Lokasi Rak -->
                    <div class="col-12 col-md-4">
                        <label class="form-label">Lokasi Rak <span class="text-danger">*</span></label>
                        <input v-model="formTambah.lokasiRak" type="text" class="form-control" 
                               placeholder="Contoh: R1-A3" required>
                    </div>

                    <!-- Harga -->
                    <div class="col-12 col-md-4">
                        <label class="form-label">Harga (Rp) <span class="text-danger">*</span></label>
                        <input v-model.number="formTambah.harga" type="number" class="form-control" 
                               placeholder="50000" min="1" step="1000" required>
                        <small v-if="errorHarga" class="text-danger d-block mt-1">{{ errorHarga }}</small>
                    </div>

                    <!-- Stok -->
                    <div class="col-12 col-md-2">
                        <label class="form-label">Stok <span class="text-danger">*</span></label>
                        <input v-model.number="formTambah.qty" type="number" class="form-control" 
                               placeholder="0" min="0" required>
                        <small v-if="errorQty" class="text-danger d-block mt-1">{{ errorQty }}</small>
                    </div>

                    <!-- Safety Stock -->
                    <div class="col-12 col-md-2">
                        <label class="form-label">Safety <span class="text-danger">*</span></label>
                        <input v-model.number="formTambah.safety" type="number" class="form-control" 
                               placeholder="10" min="1" required>
                        <small v-if="errorSafety" class="text-danger d-block mt-1">{{ errorSafety }}</small>
                    </div>

                    <!-- Catatan -->
                    <div class="col-12">
                        <label class="form-label">Catatan (opsional)</label>
                        <textarea v-model="formTambah.catatanHTML" class="form-control" rows="2" 
                                  placeholder="Catatan tambahan..."></textarea>
                    </div>

                    <!-- Tombol Submit -->
                    <div class="col-12">
                        <button type="submit" class="btn btn-success">Simpan Bahan Ajar</button>
                        <button type="button" @click="resetFormTambah" class="btn btn-secondary ms-2">Reset</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ===== FILTER & SORT ===== -->
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="h6 mb-3">Filter & Sorting</h2>
                <div class="row g-3">
                    <!-- Filter UT-Daerah -->
                    <div class="col-12 col-md-3">
                        <label class="form-label">UT-Daerah</label>
                        <select v-model="filterUpbjj" class="form-select">
                            <option value="">Semua Daerah</option>
                            <option v-for="upbjj in upbjjList" :key="upbjj" :value="upbjj">{{ upbjj }}</option>
                        </select>
                    </div>

                    <!-- Filter Kategori (dependent on UT-Daerah) -->
                    <div class="col-12 col-md-3">
                        <label class="form-label">Kategori Mata Kuliah</label>
                        <select v-model="filterKategori" class="form-select" :disabled="!filterUpbjj">
                            <option value="">Semua Kategori</option>
                            <option v-for="kat in availableKategori" :key="kat" :value="kat">{{ kat }}</option>
                        </select>
                    </div>

                    <!-- Filter Stok Kritis -->
                    <div class="col-12 col-md-3">
                        <label class="form-label">Status Stok</label>
                        <select v-model="filterStokKritis" class="form-select">
                            <option value="">Semua</option>
                            <option value="kritis">Stok < Safety</option>
                            <option value="habis">Stok = 0</option>
                        </select>
                    </div>

                    <!-- Sort -->
                    <div class="col-12 col-md-2">
                        <label class="form-label">Urutkan</label>
                        <select v-model="sortBy" class="form-select">
                            <option value="">Default</option>
                            <option value="judul">Judul A-Z</option>
                            <option value="qty">Stok (rendah)</option>
                            <option value="harga">Harga (rendah)</option>
                        </select>
                    </div>

                    <!-- Reset -->
                    <div class="col-12 col-md-1 d-flex align-items-end">
                        <button @click="resetFilter" class="btn btn-secondary w-100">Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== TABEL STOK ===== -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Kode MK</th>
                                <th scope="col">Nama Mata Kuliah</th>
                                <th scope="col">Kategori</th>
                                <th scope="col">UT-Daerah</th>
                                <th scope="col">Lokasi Rak</th>
                                <th scope="col" class="text-end">Stok</th>
                                <th scope="col" class="text-end">Safety</th>
                                <th scope="col">Status</th>
                                <th scope="col">Catatan</th>
                                <th scope="col">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(item, index) in stokFiltered" :key="item.kode">
                                <!-- Mode Edit -->
                                <template v-if="editIndex === index">
                                    <td>{{ item.kode }}</td>
                                    <td><input v-model="editData.judul" class="form-control form-control-sm"></td>
                                    <td>
                                        <select v-model="editData.kategori" class="form-select form-select-sm">
                                            <option v-for="kat in kategoriList" :key="kat" :value="kat">{{ kat }}</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select v-model="editData.upbjj" class="form-select form-select-sm">
                                            <option v-for="upbjj in upbjjList" :key="upbjj" :value="upbjj">{{ upbjj }}</option>
                                        </select>
                                    </td>
                                    <td><input v-model="editData.lokasiRak" class="form-control form-control-sm"></td>
                                    <td><input v-model.number="editData.qty" type="number" class="form-control form-control-sm text-end"></td>
                                    <td><input v-model.number="editData.safety" type="number" class="form-control form-control-sm text-end"></td>
                                    <td colspan="3">
                                        <button @click="simpanEdit(index)" class="btn btn-success btn-sm me-1">Simpan</button>
                                        <button @click="batalEdit" class="btn btn-secondary btn-sm">Batal</button>
                                    </td>
                                </template>
                                <!-- Mode View -->
                                <template v-else>
                                    <td>{{ item.kode }}</td>
                                    <td>{{ item.judul }}</td>
                                    <td>{{ item.kategori }}</td>
                                    <td>{{ item.upbjj }}</td>
                                    <td>{{ item.lokasiRak }}</td>
                                    <td class="text-end">{{ item.qty }}</td>
                                    <td class="text-end">{{ item.safety }}</td>
                                    <td>
                                        <span v-if="item.qty === 0" class="badge bg-danger">Habis</span>
                                        <span v-else-if="item.qty < item.safety" class="badge bg-warning text-dark">Kritis</span>
                                        <span v-else class="badge bg-success">Aman</span>
                                    </td>
                                    <td><span v-html="item.catatanHTML"></span></td>
                                    <td>
                                        <button @click="mulaiEdit(index)" class="btn btn-primary btn-sm">Edit</button>
                                    </td>
                                </template>
                            </tr>
                            <tr v-if="stokFiltered.length === 0">
                                <td colspan="10" class="text-center text-muted">Tidak ada data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <!-- Stok App -->
    <script src="js/stok-app.js"></script>
    <script>
        // ===== PROTEKSI HALAMAN =====
        // Mengecek apakah user sudah login dengan memeriksa sessionStorage
        // Jika belum login, redirect ke halaman index.html
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) window.location.href = 'index.html';

        // ===== LOAD NAVBAR =====
        // Mengambil navbar dari file terpisah dan menampilkan nama user yang sedang login
        fetch('partials/navbar.html').then(r => r.text()).then(html => {
            document.getElementById('navbar').innerHTML = html;
            const el = document.getElementById('userName');
            if (el) el.textContent = currentUser.nama;
        });

        // ===== FUNGSI LOGOUT =====
        /**
         * Fungsi untuk logout user
         * Menghapus data user dari sessionStorage dan redirect ke halaman login
         */
        function logout() { 
            sessionStorage.removeItem('currentUser'); 
            window.location.href = 'index.html'; 
        }
        window.logout = logout;

        // ===== DOKUMENTASI =====
        /*
        SISTEM MANAJEMEN STOK BAHAN AJAR
        
        Program ini digunakan untuk mengelola stok bahan ajar di Universitas Terbuka.
        
        Fitur-fitur utama:
        1. Filter data berdasarkan:
           - UT-Daerah (UPBJJ)
           - Kategori Mata Kuliah (dependent filter)
           - Status Stok (kritis/habis)
        2. Sorting data berdasarkan:
           - Judul (A-Z)
           - Jumlah Stok (terendah)
           - Harga (terendah)
        3. Edit inline data stok
        4. Status badge otomatis (Habis/Kritis/Aman)
        5. Reset filter
        
        Dependencies:
        - Vue.js 2.7.14 untuk reactive data binding
        - Bootstrap 5.3.3 untuk UI components
        */
    </script>
</body>
</html>
