<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking Pengiriman</title>
    
    <!-- Bootstrap CSS untuk komponen UI -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <!-- CSS kustom (helper class) -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Placeholder navbar akan diinject via JavaScript -->
    <div id="navbar"></div>

    <!-- Container utama dengan margin vertikal -->
    <div id="trackingApp" class="container my-4">
        
        <!-- ===== FORM TAMBAH DO BARU ===== -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h1 class="h4 mb-3">Tambah Delivery Order Baru</h1>
                
                <form @submit.prevent="tambahDO" class="row g-3">
                    <!-- Nomor DO (Auto Generated - Readonly) -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nomor DO (Auto)</label>
                        <input type="text" class="form-control" :value="nomorDOBaru" readonly>
                    </div>

                    <!-- NIM -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">NIM</label>
                        <input v-model="formDO.nim" type="text" class="form-control" placeholder="Masukkan NIM" required>
                    </div>

                    <!-- Nama -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nama Mahasiswa</label>
                        <input v-model="formDO.nama" type="text" class="form-control" placeholder="Masukkan Nama" required>
                    </div>

                    <!-- Ekspedisi -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Ekspedisi</label>
                        <select v-model="formDO.ekspedisi" class="form-select" required>
                            <option value="">-- Pilih Ekspedisi --</option>
                            <option value="JNE Regular">JNE Regular</option>
                            <option value="JNE Express">JNE Express</option>
                        </select>
                    </div>

                    <!-- Paket Bahan Ajar -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Paket Bahan Ajar</label>
                        <select v-model="formDO.paketKode" class="form-select" required>
                            <option value="">-- Pilih Paket --</option>
                            <option v-for="p in paket" :key="p.kode" :value="p.kode">
                                {{ p.kode }} - {{ p.nama }}
                            </option>
                        </select>
                        <!-- Detail Isi Paket (muncul setelah pilih) -->
                        <div v-if="paketTerpilih" class="mt-2 p-2 bg-light rounded small">
                            <strong>Isi Paket:</strong>
                            <ul class="mb-0 mt-1">
                                <li v-for="mk in paketTerpilih.isi" :key="mk">{{ mk }}</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Tanggal Kirim -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Tanggal Kirim</label>
                        <input v-model="formDO.tanggalKirim" type="date" class="form-control" required>
                    </div>

                    <!-- Total Harga (Auto dari paket - Readonly) -->
                    <div class="col-12 col-md-6">
                        <label class="form-label">Total Harga</label>
                        <input type="text" class="form-control" :value="formatRupiah(formDO.total)" readonly>
                    </div>

                    <!-- Tombol Submit -->
                    <div class="col-12">
                        <button type="submit" class="btn btn-success">Tambah DO</button>
                        <button type="button" @click="resetForm" class="btn btn-secondary ms-2">Reset</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ===== FORM PENCARIAN TRACKING ===== -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="h4 mb-3">Tracking Pengiriman</h1>

                <form @submit.prevent="cariDO" class="row g-2">
                    <div class="col-12 col-md-6">
                        <label for="inputNomorDO" class="form-label">Nomor Delivery Order</label>
                        <input v-model="cariNoDO" type="text" class="form-control" id="inputNomorDO" 
                               placeholder="Masukkan Nomor DO, contoh: DO2025-0001" required>
                    </div>
                    
                    <div class="col-12 col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Cari</button>
                    </div>
                </form>

                <!-- Alert Tidak Ditemukan -->
                <div v-if="!hasilTracking && cariNoDO" class="alert alert-warning mt-3">
                    Data tidak ditemukan. Periksa Nomor DO dan coba lagi.
                </div>

                <!-- Area Hasil Pencarian -->
                <div v-if="hasilTracking" class="mt-4">
                    
                    <!-- Header: Nomor DO dan Status Badge -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small">Nomor DO</div>
                                <div class="fw-semibold">{{ hasilTracking.noDO }}</div>
                            </div>
                            <div>
                                <span class="text-muted small d-block">Status</span>
                                <span :class="'badge ' + statusBadge">{{ hasilTracking.status }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Nama Mahasiswa -->
                    <div class="mb-3">
                        <div class="text-muted small">Nama Mahasiswa</div>
                        <div class="fs-6 fw-semibold">{{ hasilTracking.nama }}</div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">Progress Pengiriman</span>
                            <span class="small fw-semibold">{{ progressPersen }}%</span>
                        </div>
                        <div class="progress">
                            <div :class="'progress-bar ' + progressBar" :style="{width: progressPersen + '%'}"></div>
                        </div>
                    </div>

                    <!-- Detail dan Timeline -->
                    <div class="row g-3">
                        <!-- Kolom Detail Pengiriman -->
                        <div class="col-12 col-lg-6">
                            <div class="card">
                                <div class="card-body">
                                    <h2 class="h6">Detail Pengiriman</h2>
                                    <div class="row row-cols-1 gy-2 mt-2">
                                        <div class="col d-flex justify-content-between">
                                            <span class="text-muted">Ekspedisi</span>
                                            <strong>{{ hasilTracking.ekspedisi }}</strong>
                                        </div>
                                        <div class="col d-flex justify-content-between">
                                            <span class="text-muted">Tanggal Kirim</span>
                                            <strong>{{ hasilTracking.tanggalKirim }}</strong>
                                        </div>
                                        <div class="col d-flex justify-content-between">
                                            <span class="text-muted">Jenis Paket</span>
                                            <strong>{{ hasilTracking.paket }}</strong>
                                        </div>
                                        <div class="col d-flex justify-content-between">
                                            <span class="text-muted">Total Pembayaran</span>
                                            <strong>{{ formatRupiah(hasilTracking.total) }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kolom Timeline Riwayat Perjalanan -->
                        <div class="col-12 col-lg-6">
                            <div class="card">
                                <div class="card-body">
                                    <h2 class="h6">Riwayat Perjalanan</h2>
                                    <ul class="list-group list-group-flush mt-2">
                                        <li v-for="item in hasilTracking.perjalanan" :key="item.waktu" class="list-group-item">
                                            <div class="small text-muted">{{ item.waktu }}</div>
                                            <div>{{ item.keterangan }}</div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <!-- Tracking App -->
    <script src="js/tracking-app.js"></script>
    <script>
        // ===== PROTEKSI HALAMAN =====
        // Mengecek apakah user sudah login dengan memeriksa sessionStorage
        // Jika belum login, redirect ke halaman index.html
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) window.location.href = 'index.html';

        // ===== LOAD NAVBAR =====
        // Mengambil navbar dari file terpisah dan menampilkan nama user yang sedang login
        fetch('partials/navbar.html').then(r => r.text()).then(html => {
            document.getElementById('navbar').innerHTML = html;
            const el = document.getElementById('userName');
            if (el) el.textContent = currentUser.nama;
        });

        // ===== FUNGSI LOGOUT =====
        /**
         * Fungsi untuk logout user
         * Menghapus data user dari sessionStorage dan redirect ke halaman login
         */
        function logout() { 
            sessionStorage.removeItem('currentUser'); 
            window.location.href = 'index.html'; 
        }
        window.logout = logout;

        // ===== DOKUMENTASI =====
        /*
        SISTEM TRACKING PENGIRIMAN DELIVERY ORDER
        
        Program ini digunakan untuk tracking pengiriman bahan ajar ke mahasiswa.
        
        Fitur-fitur utama:
        1. Tambah Delivery Order (DO) baru:
           - Auto generate nomor DO
           - Pilih paket bahan ajar
           - Detail isi paket otomatis tampil
           - Total harga otomatis
        2. Tracking pengiriman:
           - Cari berdasarkan nomor DO
           - Progress bar visual
           - Timeline riwayat perjalanan
           - Status badge dinamis
        3. Format rupiah otomatis
        
        Dependencies:
        - Vue.js 2.7.14 untuk reactive data binding
        - Bootstrap 5.3.3 untuk UI components
        */
    </script>
</body>
</html>
